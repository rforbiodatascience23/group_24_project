---
title: "Human augmentation"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(dplyr)
library(patchwork)
library(ggplot2)
```

```{r}
human_clean_long
```

We are going to merge our clean human data sets and select only the variables that we want

```{r}
human_joined <- human_clean_long |> 
  left_join(human_suppl_clean, join_by(treatment, cell_line)) |>
  select(gene_id,
         cell_line,
         treatment,
         expression_levels,
         genotype) |>
  relocate(genotype, .before = 2)

human_joined
```

### This is were we create the new metrics for our augmented file

In order to work with the DMSO and G007.LK values we chose to move on with log transformation in order to reduce the heteroscedasticity and stabilize the variance among the expression levels.

Because we can't log on zeros we add on all the values the 0.99% of the minimum positive values of the Expression levels feature as an offset

```{r}
min_pos_value <- human_joined |>
  select(expression_levels) |>
  filter(expression_levels != 0) |>
  summarize(min = min(expression_levels)) |>
  pull()

human_trans <- human_joined |> 
  mutate(expression_levels = (expression_levels + 0.99 * min_pos_value)) 

human_trans
```

```{r}
# Now we log2 transform the expression levels 
human_trans <- human_trans |> 
  mutate(log2_expression_levels = log2(expression_levels)) 

human_trans
```

```{r}
# Here we create dummy variables to be used for analysis later on
human_aug <- human_trans |> 
  mutate(treatment = case_when(treatment == "DMSO" ~ 0,
                               treatment == "G007.LK" ~ 1))

human_aug
```

```{r}
#Write the augmented dataset to a tsv file

write_tsv(human_aug, "../data/03_dat_aug_human.tsv")
```

IF PCA

```{r}
 # We also want to create a wide version where the compounds are on different columns 
 human_trans_wide <- human_trans |> 
   pivot_wider(names_from = treatment, 
               values_from = log2_expression_levels )
 human_trans_wide
```

```{r}
#Our purpose is to find genes that were either up or down regulated when treating the cells with G007.LK in comparison when we only provide them the solvent DMSO. For that reason we calculate the log2 fold change, which is a way of measuring change in expression level of a gene between two different conditions.

 human_trans_wide <- human_trans_wide |>
   mutate(log2fc = G007.LK - DMSO)

 human_trans_wide
```
