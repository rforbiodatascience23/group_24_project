---
title: "Human augmentation"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(dplyr)
library(patchwork)
library(ggplot2)

human_clean_long <- read_tsv(file = "../data/02_dat_clean_human.tsv.gz")
human_suppl_clean <- read_tsv(file = "../data/02_dat_clean_human_suppl.tsv.gz")
```

We are going to merge our clean human data sets and select only the variables that we want

```{r}
human_joined <- human_clean_long |> 
  left_join(human_suppl_clean, join_by(treatment, cell_line)) |>
  select(gene_id,
         cell_line,
         treatment,
         expression_levels,
         genotype) |>
  relocate(genotype, .before = 3)

human_joined
```

### This is were we create the new metrics for our augmented file

In order to work with the DMSO and G007.LK values we chose to move on with log transformation in order to reduce the heteroscedasticity and stabilize the variance among the expression levels.

Because we can't log on zeros we add on all the values the 0.99% of the minimum positive values of the Expression levels feature as an offset

```{r}
min_pos_value <- human_joined |>
  select(expression_levels) |>
  filter(expression_levels != 0) |>
  summarize(min = min(expression_levels)) |>
  pull()

human_aug <- human_joined |> 
  mutate(expression_levels = (expression_levels + 0.65 * min_pos_value)) 

human_aug

## add it to only zero
```

```{r}
# To be used for the bar plots
human_aug <- human_aug |> 
  mutate(log2_expression_levels = log2(expression_levels)) 

human_aug
```

```{r}
human_aug_sep_treat <- human_aug |>
  select(-expression_levels)|>
  pivot_wider(names_from = "treatment",
              values_from = "log2_expression_levels")

human_aug_sep_treat
```

```{r}
# To be used for PCA 
human_aug_log2fc <- human_aug_sep_treat |>
  mutate(log2foldchange = G007LK - DMSO)|>
  select(-c(DMSO, G007LK))

human_aug_log2fc
```

```{r}
#Write the augmented datasets to two tsv files

write_tsv(human_aug, "../data/03_dat_aug_human.tsv.gz")
write_tsv(human_aug_log2fc, "../data/03_dat_aug_human_log2fc.tsv.gz")
```
